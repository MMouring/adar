AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Parameters:
  stage:
    Type: String
    Description: Deployment stage (dev, stage, prod)
    AllowedValues:
      - dev
      - stage
      - prod

Parameters:
  stage:
    Type: String
    Description: Deployment stage (dev, stage, prod)
    AllowedValues:
      - dev
      - stage
      - prod
  googleAccount:
    Type: String
    Default: google-account
  googleAccountLog:
    Type: String
    Default: google-account-log
  googleAd:
    Type: String
    Default: google-ad
  googleAdLog:
    Type: String
    Default: google-ad-log
  googleCampaign:
    Type: String
    Default: google-campaign
  googleCampaignLog:
    Type: String
    Default: google-campaign-log
  googleAdGroup:
    Type: String
    Default: google-ad-group
  googleAdGroupLog:
    Type: String
    Default: google-ad-group-log
  googleAsset:
    Type: String
    Default: google-asset
  googleAssetLog:
    Type: String
    Default: google-asset-log
  googleAssetSet:
    Type: String
    Default: google-asset-set
  googleAssetSetLog:
    Type: String
    Default: google-asset-set-log
  googleFeed:
    Type: String
    Default: google-feed
  googleFeedLog:
    Type: String
    Default: google-feed-log
  googleFeedItem:
    Type: String
    Default: google-feed-item
  googleFeedItemLog:
    Type: String
    Default: google-feed-item-log
  googleKeyword:
    Type: String
    Default: google-keyword
  googleKeywordLog:
    Type: String
    Default: google-keyword-log
  googleSharedSet:
    Type: String
    Default: google-shared-set
  googleSharedSetKeyword:
    Type: String
    Default: google-shared-set-keyword
  googleSharedSetLog:
    Type: String
    Default: google-shared-set-log
  googleSharedSetKeywordLog:
    Type: String
    Default: google-shared-set-keyword-log

  Layers:
    stage:
      GoogleAdsLayer: "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:google-ads-layer:4"
      BingAdsLayer: "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:bing-ads-layer:4"
    prod:
      GoogleAdsLayer: "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:google-ads-layer:2"
      BingAdsLayer: "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:bing-ads-layer:2"
    dev:
      GoogleAdsLayer: "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:google-ads-layer:1"
      BingAdsLayer: "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:bing-ads-layer:1"

Resources:
  GoogleAdsEditorFeedItemLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub googleAdsEditorFeedItemV1
      Description: Updates Google Ads Feed Items
      Handler: feed_item_lambda.handler
      Runtime: python3.13
      CodeUri: ./src
      MemorySize: 128
      Role:
        Fn::GetAtt:
          - GoogleAdsEditorRole
          - Arn
      Timeout: 900
      Environment:
        Variables:
          DEBUG: !Sub ${debug}
          GOOGLE_ADS_REFRESH_TOKEN: !Sub ${googleAdsRefreshToken}
          GOOGLE_ADS_CLIENT_ID: !Sub ${googleAdsClientId}
          GOOGLE_ADS_CLIENT_SECRET: !Sub ${googleAdsClientSecret}
          GOOGLE_ADS_DEVELOPER_TOKEN: !Sub ${googleAdsDeveloperToken}
          GOOGLE_ADS_LOGIN_CUSTOMER_ID: !Sub ${googleAdsLoginCustomerId}
          GOOGLE_ADS_USE_PROTO_PLUS: true
          GOOGLE_SHARED_SET_KEYWORD_LOG: !Ref googleSharedSetKeywordLog
      Layers:
        - !Sub ${!FindInMap [Layers, !Ref stage, GoogleAdsLayer]}
        - !Sub ${!FindInMap [Layers, !Ref stage, BingAdsLayer]}

  GoogleAdsEditorSharedSetKeywordLogFirehose:
    Type: AWS::KinesisFirehose::DeliveryStream
    Properties:
      DeliveryStreamName: !Ref googleSharedSetKeywordLog
      DeliveryStreamType: DirectPut
      ExtendedS3DestinationConfiguration:
        BucketARN: arn:aws:s3:::data.ihsadvantage
        BufferingHints:
          IntervalInSeconds: 300
          SizeInMBs: 5
        CloudWatchLoggingOptions:
          Enabled: true
          LogGroupName: !Sub /aws/kinesisfirehose/${googleSharedSetKeywordLog}
          LogStreamName: S3Delivery
        CompressionFormat: GZIP
        ErrorOutputPrefix: 'json/errors/google/shared-set-keyword-log/error_type=!{firehose:error-output-type}/partition_date=!{timestamp:yyyy}-!{timestamp:MM}-!{timestamp:dd}/'
        Prefix: 'json/google/shared-set-keyword-log/partition_date=!{timestamp:yyyy}-!{timestamp:MM}-!{timestamp:dd}/'
        RoleARN: !Sub 'arn:aws:iam::${AWS::AccountId}:role/firehose_delivery_role'
